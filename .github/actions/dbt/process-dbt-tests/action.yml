name: 'Process DBT Test Results'
description: 'Processes and formats DBT test results from output log'

inputs:
  project-folder:
    description: 'Path to the DBT project folder'
    required: true

runs:
  using: "composite"
  steps:
    - shell: bash
      working-directory: ${{ inputs.project-folder }}
      run: |
        echo "=== Current Directory ==="
        pwd

        echo -e "\n=== Listing root project directory ==="
        ls -la /home/runner/work/StarlightDataWarehouseTemplate/StarlightDataWarehouseTemplate/

        echo -e "\n=== Listing parent directory ==="
        ls -la /home/runner/work/StarlightDataWarehouseTemplate/

        echo -e "\n=== Listing current directory ==="
        ls -la ./

        echo -e "\n=== Listing target directory ==="
        ls -la target/

        echo -e "\n=== Listing target/compiled directory ==="
        ls -la target/compiled/

        echo -e "\n=== Finding all .sql files ==="
        find . -name "*.sql"

        if [ ! -f "dbt_output.log" ]; then
          echo "No test output file found"
          exit 0
        fi

        # Get number of errors from the "Done." line
        num_failed_tests=$(grep "Done." "dbt_output.log" | grep -o "ERROR=[0-9]*" | cut -d'=' -f2)

        if [ -z "$num_failed_tests" ] || [ "$num_failed_tests" -eq 0 ]; then
          echo "No failed tests found"
          exit 0
        fi

        echo -e "\nðŸ”´ Found $num_failed_tests failed tests"
        echo "----------------------------------------"

        while IFS= read -r line; do
          if [[ $line == *"compiled code at"* ]]; then
            sql_file=$(echo "$line" | awk '{print $NF}')
            test_name=$(basename "$sql_file" .sql)

            echo "Looking for SQL file: $sql_file"
            echo "Complete path: $(pwd)/$sql_file"

            echo "ðŸ“„ SQL for failed test: $test_name"
            echo "```sql"
            if [ -f "$sql_file" ]; then
              cat "$sql_file"
            else
              echo "SQL file not found. Directory contents where it should be:"
              dirname_path=$(dirname "$sql_file")
              if [ -d "$dirname_path" ]; then
                ls -la "$dirname_path"
              else
                echo "Directory $dirname_path does not exist"
              fi
            fi
            echo "```"
            echo "----------------------------------------"
          fi
        done < "dbt_output.log"
